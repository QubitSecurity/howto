<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PLURA-XDR Knowledge Hub</title>

  <!-- Favicon (레거시/광범위 호환) -->
  <link rel="icon" href="https://w.plura.io/favicon.ico" sizes="any">

  <!-- 다크 모드 강제 -->
  <meta name="color-scheme" content="dark">

  <!-- GitHub Markdown 스타일 & 코드 하이라이트 & KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.8.1/github-markdown.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">

  <style>
    :root { color-scheme: dark; }

    /* 배경/레이아웃 */
    body{ margin:0; background:#0b0c0f; color:#e5e7eb; }
    .page { max-width: 980px; margin: 0 auto; padding: 24px; }
    .frame {
      background: transparent;
      border: 1px solid #000 !important;  /* 경계선 항상 검정 */
      border-radius:12px;
      padding:24px;
      box-shadow:none !important;         /* 흰 그림자 제거 */
    }

    /* Markdown 다크 고정 */
    .markdown-body { box-sizing:border-box; min-width:200px; max-width:100%; background:transparent; color:inherit; }
    .markdown-body h1,.markdown-body h2,.markdown-body h3,
    .markdown-body h4,.markdown-body h5,.markdown-body h6 { color:#fff; }
    .markdown-body hr { background-color:#374151; }
    .markdown-body a { color:#93c5ff; }
    .markdown-body blockquote { color:#d1d5db; border-left-color:#374151; }
    .markdown-body code { background:#111827; color:#e5e7eb; }
    .markdown-body pre { background:#0f172a; border:1px solid #374151; color:#e5e7eb; }
    .markdown-body pre code { background:transparent; }

    /* 배지 */
    .badge{ display:inline-block; font-size:12px; color:#e5e7eb; background:#111827; border:1px solid #1f2937; padding:4px 8px; border-radius:8px; margin-bottom:12px; }

    /* 코드블록 Copy 버튼 */
    .code-wrap{ position:relative; }
    .copy-btn{
      position:absolute; top:8px; right:8px; font-size:12px;
      padding:6px 8px; border-radius:6px; border:1px solid #374151;
      background:#111827; color:#e5e7eb; cursor:pointer;
    }

    /* ===============================
       === 표 시각 고정: 배경=검정, 글자=흰색, 라인=흰색 ===
       =============================== */
    .markdown-body table{
      /* GitHub Markdown CSS가 사용하는 경계선 변수도 흰색으로 통일 */
      --color-border-default: #fff;
      --color-border-muted:   #fff;
      --color-border-subtle:  #fff;

      border-collapse: collapse !important;
      display: table !important;
      width: auto !important;
      max-width: 100%;
      background: #000 !important;              /* 표 전체 배경 = 검정 */
      border: 1px solid #fff !important;        /* 바깥 테두리 = 흰색 */
    }
    /* 모든 셀(th/td)의 배경/텍스트/테두리 */
    .markdown-body table > :not(caption) > * > *{
      background: #000 !important;              /* 셀 배경 = 검정 */
      color: #fff !important;                   /* 셀 글자 = 흰색 */
      border: 1px solid #fff !important;        /* 셀 테두리 = 흰색 */
    }
    /* 행 상단 경계선도 흰색으로 */
    .markdown-body table tr{
      border-top: 1px solid #fff !important;
    }
    /* 헤더 하단 강조선(선택) */
    .markdown-body table thead th{
      border-bottom: 2px solid #fff !important;
    }
    /* 표 내부 링크도 흰색으로 통일 */
    .markdown-body table a{
      color:#fff !important;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="frame">
      <div id="badge" class="badge"></div>
      <article id="app" class="markdown-body">불러오는 중…</article>
    </div>
  </div>

  <!-- ✅ 순서 중요: highlight.js 먼저 -->
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>

  <!-- 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it-emoji@3.0.0/dist/markdown-it-emoji.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it-footnote@4.0.0/dist/markdown-it-footnote.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>

  <script>
    /**
     * url-index 확장:
     * - 외부 URL을 ?doc= 로 직접 불러옵니다.
     * - 단, Raw 주소만 지원합니다. (github.com/.../blob/... → 자동 변환 없음)
     *   GitHub 파일 페이지에서 Raw 버튼 클릭 후 나오는
     *   https://raw.githubusercontent.com/... 주소를 사용하세요.
     * - 렌더 전 자동 처리:
     *   1) 문서 상단 YAML 프론트매터(--- ... ---) 제거
     *   2) <!--more-->, <!-- more -->, <!–more–>, <!—more—> 마커 제거
     */

    // Mermaid
    mermaid.initialize({ startOnLoad: false, theme: "default" });

    // Markdown-it (하이라이트 가드 포함)
    const md = window.markdownit({
      html: false,
      linkify: true,
      typographer: true,
      highlight: function (str, lang) {
        const hasHLJS = typeof window.hljs !== 'undefined' && hljs && typeof hljs.highlight === 'function';
        if (hasHLJS && lang && typeof hljs.getLanguage === 'function' && hljs.getLanguage(lang)) {
          try { return hljs.highlight(str, { language: lang }).value; } catch {}
        }
        if (hasHLJS && typeof hljs.highlightAuto === 'function') {
          try { return hljs.highlightAuto(str).value; } catch {}
        }
        return '';
      }
    }).use(window.markdownitEmoji).use(window.markdownitFootnote);

    const el = document.getElementById('app');
    const badge = document.getElementById('badge');

    // ?doc=... 없으면 README.md
    function getDocFromQuery() {
      const u = new URL(window.location.href);
      return u.searchParams.get('doc') || 'README.md';
    }

    // index.html과 같은 디렉터리 기준 절대 URL
    function toAbsoluteUrl(relPath) {
      const baseDir = window.location.origin + window.location.pathname.replace(/[^/]*$/, ''); // /path/of/index.html/
      return new URL(relPath, baseDir).href;
    }

    // 외부 URL은 그대로 사용, 상대경로만 절대경로로
    function resolveDocUrl(pathLike) {
      if (/^https?:\/\//i.test(pathLike) || pathLike.startsWith('/')) return pathLike;
      return toAbsoluteUrl(pathLike);
    }

    // GitHub blob 링크 여부 (Raw만 지원)
    function isGitHubBlobUrl(u) {
      try {
        const x = new URL(u);
        return x.hostname === 'github.com' && /\/blob\//.test(x.pathname);
      } catch { return false; }
    }

    // YAML 프론트매터 제거
    function stripFrontMatter(src) {
      const s = src.replace(/^\uFEFF/, ''); // BOM 허용
      const m = s.match(/^---\s*[\s\S]*?\r?\n---\s*(?:\r?\n)?/);
      return m ? s.slice(m[0].length) : s;
    }

    // WordPress/Hugo "more" 마커 제거: <!--more-->, <!-- more -->, <!–more–>, <!—more—>
    function stripMoreMarkers(src) {
      const re = /<\!\s*[-\u2013\u2014]{2}\s*more\s*[-\u2013\u2014]{2}\s*>/gi;
      return src.replace(re, '');
    }

    // Mermaid 렌더
    async function renderMermaidIn(container) {
      const blocks = container.querySelectorAll('pre code.language-mermaid');
      for (const code of blocks) {
        const raw = code.textContent;
        const wrapper = document.createElement('div');
        wrapper.className = 'mermaid';
        wrapper.textContent = raw;
        const pre = code.closest('pre');
        pre.replaceWith(wrapper);
      }
      if (container.querySelector('.mermaid')) {
        try { await mermaid.run({ nodes: container.querySelectorAll('.mermaid') }); } catch {}
      }
    }

    // 코드 Copy 버튼
    function addCopyButtons(container) {
      const pres = container.querySelectorAll('pre');
      pres.forEach(pre => {
        const wrap = document.createElement('div');
        wrap.className = 'code-wrap';
        pre.replaceWith(wrap);
        wrap.appendChild(pre);
        const btn = document.createElement('button');
        btn.className = 'copy-btn';
        btn.textContent = 'Copy';
        btn.addEventListener('click', async () => {
          const code = pre.querySelector('code')?.innerText || '';
          try { await navigator.clipboard.writeText(code);
            btn.textContent = 'Copied!'; setTimeout(() => btn.textContent = 'Copy', 800);
          } catch {}
        });
        wrap.appendChild(btn);
      });
    }

    // 메인 렌더
    async function renderDoc(pathLike) {
      const url = resolveDocUrl(pathLike);
      badge.textContent = pathLike;
      el.textContent = '불러오는 중…';

      // Raw 전용 안내 (자동 변환 없음)
      if (isGitHubBlobUrl(url)) {
        el.innerHTML = `
          <div style="padding:12px;border:1px solid #4b5563;border-radius:8px;background:#111827;">
            <p style="margin:0 0 6px 0;">이 URL은 <b>GitHub blob</b> 주소입니다. 이 페이지는 <b>Raw 주소만</b> 지원합니다.</p>
            <p style="margin:0;">GitHub 파일 페이지에서 <b>Raw</b> 버튼을 클릭해 나온
            <code>https://raw.githubusercontent.com/...</code> 주소를 사용하세요.</p>
          </div>`;
        return;
      }

      try {
        const res = await fetch(url, { cache: 'no-store', credentials: 'omit' }); // 원격 리소스: 쿠키 불요
        if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
        const text = await res.text();

        // 1) 프론트매터 제거  2) <!--more--> 류 마커 제거
        const mdText = stripMoreMarkers(stripFrontMatter(text));

        if (/^\s*<!doctype html>/i.test(mdText) || /^\s*<html\b/i.test(mdText)) {
          // 서버가 HTML을 준 경우 그대로
          el.innerHTML = mdText;
        } else {
          const unsafe = md.render(mdText);
          const safe = DOMPurify.sanitize(unsafe, { USE_PROFILES: { html: true } });
          el.innerHTML = safe;

          // 수식/다이어그램/Copy 버튼
          try {
            renderMathInElement(el, {
              delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false},
                {left: "\\(", right: "\\)", display: false},
                {left: "\\[", right: "\\]", display: true}
              ],
              throwOnError: false
            });
          } catch {}
          await renderMermaidIn(el);
          addCopyButtons(el);
        }
      } catch (err) {
        console.error(err);
        el.innerHTML = '<p>문서를 불러오지 못했습니다. 경로를 확인하세요.</p>';
      }
    }

    // 초기 로드
    renderDoc(getDocFromQuery());
  </script>
</body>
</html>

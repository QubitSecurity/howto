<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PLURA-XDR Knowledge Hub</title>

  <!-- GitHub Markdown 스타일 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.8.1/github-markdown.min.css">
  <!-- 코드 하이라이트 테마 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
  <!-- KaTeX 수식 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">

  <style>
    :root { color-scheme: light dark; }
    body{ margin:0; background:#0b0c0f; }
    .page { max-width: 980px; margin: 0 auto; padding: 24px; }
    .frame { background: transparent; border: 1px solid #000; border-radius:12px; padding:24px; box-shadow: none; }
    .markdown-body { box-sizing:border-box; min-width:200px; max-width:100%; }
    /* 코드블록 Copy 버튼 */
    .code-wrap{ position:relative; }
    .copy-btn{ position:absolute; top:8px; right:8px; font-size:12px; padding:6px 8px; border-radius:6px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    /* 상단 파일명 배지(선택) */
    .badge{ display:inline-block; font-size:12px; color:#555; background:#f4f4f5; border:1px solid #e4e4e7; padding:4px 8px; border-radius:8px; margin-bottom:12px; }
  </style>
</head>
<body>
  <div class="page">
    <div class="frame">
      <div id="badge" class="badge"></div>
      <article id="app" class="markdown-body">Reading…</article>
    </div>
  </div>

  <!-- ✅ 순서 중요: highlight.js 먼저 -->
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>

  <!-- 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it-emoji@3.0.0/dist/markdown-it-emoji.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it-footnote@4.0.0/dist/markdown-it-footnote.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>

  <script>
    // Mermaid
    mermaid.initialize({ startOnLoad: false, theme: "default" });

    // Markdown-it (하이라이트 가드 포함)
    const md = window.markdownit({
      html: false,
      linkify: true,
      typographer: true,
      highlight: function (str, lang) {
        const hasHLJS = typeof window.hljs !== 'undefined' && hljs && typeof hljs.highlight === 'function';
        if (hasHLJS && lang && typeof hljs.getLanguage === 'function' && hljs.getLanguage(lang)) {
          try { return hljs.highlight(str, { language: lang }).value; } catch {}
        }
        if (hasHLJS && typeof hljs.highlightAuto === 'function') {
          try { return hljs.highlightAuto(str).value; } catch {}
        }
        return ''; // 하이라이트 비활성 시 기본 렌더
      }
    }).use(window.markdownitEmoji).use(window.markdownitFootnote);

    const el = document.getElementById('app');
    const badge = document.getElementById('badge');

    // ?doc=... 없으면 README.md
    function getDocFromQuery() {
      const u = new URL(window.location.href);
      return u.searchParams.get('doc') || 'README.md';
    }

    // index.html과 같은 디렉터리 기준 절대 URL
    function toAbsoluteUrl(relPath) {
      const baseDir = window.location.origin + window.location.pathname.replace(/[^/]*$/, ''); // /xdr/diagram/
      return new URL(relPath, baseDir).href;
    }

    // Mermaid 렌더
    async function renderMermaidIn(container) {
      const blocks = container.querySelectorAll('pre code.language-mermaid');
      for (const code of blocks) {
        const raw = code.textContent;
        const wrapper = document.createElement('div');
        wrapper.className = 'mermaid';
        wrapper.textContent = raw;
        const pre = code.closest('pre');
        pre.replaceWith(wrapper);
      }
      if (container.querySelector('.mermaid')) {
        try { await mermaid.run({ nodes: container.querySelectorAll('.mermaid') }); } catch {}
      }
    }

    // 코드 Copy 버튼
    function addCopyButtons(container) {
      const pres = container.querySelectorAll('pre');
      pres.forEach(pre => {
        const wrap = document.createElement('div');
        wrap.className = 'code-wrap';
        pre.replaceWith(wrap);
        wrap.appendChild(pre);
        const btn = document.createElement('button');
        btn.className = 'copy-btn';
        btn.textContent = 'Copy';
        btn.addEventListener('click', async () => {
          const code = pre.querySelector('code')?.innerText || '';
          try {
            await navigator.clipboard.writeText(code);
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'Copy', 800);
          } catch {}
        });
        wrap.appendChild(btn);
      });
    }

    // 메인 렌더
    async function renderDoc(pathLike) {
      const url = (/^https?:\/\//i.test(pathLike) || pathLike.startsWith('/'))
        ? pathLike
        : toAbsoluteUrl(pathLike);

      badge.textContent = pathLike;
      el.textContent = '불러오는 중…';

      try {
        const res = await fetch(url, { cache: 'no-store', credentials: 'same-origin' });
        if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
        const text = await res.text();

        // 이미 HTML이면 그대로 표시
        if (/^\s*<!doctype html>/i.test(text) || /^\s*<html\b/i.test(text)) {
          el.innerHTML = text;
        } else {
          const unsafe = md.render(text);
          const safe = DOMPurify.sanitize(unsafe, { USE_PROFILES: { html: true } });
          el.innerHTML = safe;

          // 수식/다이어그램/Copy 버튼
          try {
            renderMathInElement(el, {
              delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false},
                {left: "\\(", right: "\\)", display: false},
                {left: "\\[", right: "\\]", display: true}
              ],
              throwOnError: false
            });
          } catch {}
          await renderMermaidIn(el);
          addCopyButtons(el);
        }
      } catch (err) {
        console.error(err);
        el.innerHTML = '<p>문서를 불러오지 못했습니다. 경로를 확인하세요.</p>';
      }
    }

    // 초기 로드
    renderDoc(getDocFromQuery());
  </script>
</body>
</html>

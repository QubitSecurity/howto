Solr에서는 병합 작업(Optimize)을 **Shard 단위**로 수행할 수 있습니다. SolrCloud 환경에서 **Shard**는 **리더(Leader)와 레플리카(Replica)**로 구성되며, 병합 작업은 특정 샤드에 속한 코어들에 대해 실행됩니다.

---

### **병합이 Shard 단위로 작동하는 원리**

1. **Shard의 구성 요소**:
   - 각 Shard는 하나의 **리더(Leader)**와 여러 **레플리카(Replica)**로 구성됩니다.
   - 예를 들어, `shard1`에 다음과 같은 코어가 포함될 수 있습니다:
     - **리더**: `weblog_shard1_replica_n722`
     - **레플리카**: `weblog_shard1_replica_n723`, `weblog_shard1_replica_n724`

2. **Optimize 명령의 동작**:
   - 병합 작업은 지정된 코어에 대해 실행됩니다.
   - 일반적으로 리더에서 병합 작업이 수행되며, 병합 후 변경 사항이 레플리카로 전파됩니다.
   - 레플리카에서 병합 작업을 별도로 수행할 수도 있습니다(NRT Replica의 경우).

3. **Shard 단위 병합**:
   - 특정 샤드에 속한 모든 코어(리더 및 레플리카)에 대해 병합 명령을 실행할 수 있습니다.
   - 예를 들어, `shard1`의 병합을 실행하려면:
     - 리더 코어에 대해 병합 명령을 실행:
       ```bash
       curl "http://<leader-node-ip>:8983/solr/weblog_shard1_replica_n722/update?optimize=true&maxSegments=10"
       ```
     - 필요 시, 레플리카 코어에도 병합 명령을 실행:
       ```bash
       curl "http://<replica-node-ip>:8983/solr/weblog_shard1_replica_n723/update?optimize=true&maxSegments=10"
       ```
---

- 실행 스크립트
[generate_shard_files.sh](script/generate_shard_files.sh)

---

### **Shard 단위 병합의 장점**

1. **리소스 관리**:
   - Shard 단위로 병합을 실행하면, 리소스(CPU 및 디스크 I/O) 사용량을 효율적으로 분산할 수 있습니다.

2. **병렬 작업 가능**:
   - 여러 Shard에 대해 병렬로 병합 작업을 수행하여 시간을 단축할 수 있습니다.

3. **문제 발생 시 관리 용이**:
   - 특정 Shard에서 문제가 발생해도 나머지 Shard는 독립적으로 병합 작업을 수행할 수 있습니다.

---

### **Shard 단위 병합 작업의 한계**

1. **리더와 레플리카 동기화**:
   - 리더에서 병합이 완료된 후, 레플리카와 동기화가 필요합니다.
   - TLOG/PULL 레플리카는 자동으로 동기화되지만, NRT 레플리카는 독립적으로 병합을 수행해야 할 수 있습니다.

2. **작업 분산**:
   - 병합 작업이 리더에서만 수행되면 레플리카가 자동으로 동기화되므로 리더에만 병합 작업을 실행하는 것이 더 효율적일 수 있습니다.

---

### **결론**

- 병합 작업은 Shard 단위로 실행할 수 있으며, **리더** 또는 **Shard에 속한 모든 코어**에 대해 병합을 수행할 수 있습니다.
- 가장 일반적인 방법은 **리더에서만 병합을 수행**하고, 나머지는 동기화를 통해 반영되도록 하는 것입니다.
- 위 스크립트를 사용하면 Shard 단위 병합을 자동화할 수 있습니다. 필요한 경우 맞춤형으로 수정하여 사용할 수 있습니다.

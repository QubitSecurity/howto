# /etc/nginx/proxy.conf
# -------------------------------------------------------------------
# 목적:
#  - WAF -> WEB 프록시 공통 헤더/타임아웃/SSL(SNI) 설정
#  - "원래 HTTPS 요청" 정보가 유지되도록 X-Forwarded-Proto 처리
# -------------------------------------------------------------------

proxy_redirect off;

# Host 관련 (업스트림에서 원래 Host로 라우팅/가상호스트 판단)
proxy_set_header Host              $http_host;
proxy_set_header X-Forwarded-Host  $host;
proxy_set_header X-Forwarded-Server $host;

# X-Forwarded-For
# - HAProxy가 이미 XFF를 구성하므로, WAF에서는 "그대로 전달"이 안전함
# - (기존의 $proxy_add_x_forwarded_for 사용 시 client IP가 중복될 수 있음)
include plura/xff_opt;

# ★ 중요: HAProxy가 넣은 X-Forwarded-Proto 를 그대로 전달해야 함
# - WAF는 HAProxy로부터 HTTP로 받기 때문에 $scheme 은 항상 http가 될 수 있음
proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;

# Referer
proxy_set_header Referer $http_referer;

proxy_pass_header Server;

# 성능/호환성
proxy_http_version 1.1;
proxy_set_header Connection "";

chunked_transfer_encoding on;

# 타임아웃 (업무 특성에 맞춰 조정)
proxy_connect_timeout 300;
proxy_send_timeout    300;
proxy_read_timeout    300;
send_timeout          300;

# 업스트림이 HTTPS일 때 SNI 지원
proxy_ssl_server_name on;
proxy_ssl_name        $host;

# 필요 시(인증서 검증 정책)
# proxy_ssl_verify on;
# proxy_ssl_trusted_certificate /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem;

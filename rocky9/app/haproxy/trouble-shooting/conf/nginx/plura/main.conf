# /etc/nginx/plura/main.conf
# -------------------------------------------------------------------
# 목적:
#  - WAF 서버 블록 정의
#  - 권장 흐름: HAProxy(TLS 종료) -> WAF(HTTP:80) -> WEB(HTTPS)
#
# 주의:
#  - 아래 <WEB_BACKEND_IP_OR_HOST> 는 실제 고객 WEB/L4 VIP 로 바꿔야 합니다.
#  - 사용자가 제공한 192.168.101.121 는 "HAProxy IP"로 사용 중이므로,
#    WEB 목적지 IP는 별도로 관리해야 루프가 발생하지 않습니다.
# -------------------------------------------------------------------

# ---------------------------
# 업스트림(고객 WEB/L4 VIP)
# ---------------------------
upstream kiha_web_https {
    # 예: server 192.168.101.200:443;
    server <WEB_BACKEND_IP_OR_HOST>:443;
    keepalive 32;
}

# ---------------------------
# Default server (예상치 못한 Host/경로, 헬스체크 처리)
# ---------------------------
server {
    include plura/portlist;
    server_name _;

    # HAProxy 외 접근 차단
    if ($from_haproxy = 0) { return 444; }

    # HAProxy 헬스체크 엔드포인트
    location = /health {
        access_log off;
        modsecurity off;
        add_header Content-Type text/plain;
        return 200 "ok\n";
    }

    location / {
        return 444;
    }

    include server.conf;
}

# ---------------------------
# 서비스 도메인 (HAProxy -> WAF HTTP:80)
# ---------------------------
server {
    listen 80;
    server_name gw.kiha21.or.kr;

    # HAProxy 외 접근 차단
    if ($from_haproxy = 0) { return 444; }

    location / {
        # 기존에 사용 중인 정책 파일은 "한 세트로 통일" 권장
        # (ac_0/defense_0 vs ac_1/defense_1 차이로 노드별 동작이 달라질 수 있음)
        include plura/ac_0;
        include plura/defense_0;

        # WAF -> WEB 은 HTTPS로 전달
        proxy_pass https://kiha_web_https;
        include proxy.conf;
    }

    include server.conf;
}

# ------------------------------------------------------------
# (선택) WAF 직접 HTTPS 접근이 꼭 필요할 때만 별도 운영
#  - 평소에는 비활성 또는 내부망/관리망으로만 제한 권장
#  - HAProxy 백엔드에서는 절대 이 포트로 보내지 마세요.
# ------------------------------------------------------------
# server {
#     listen 443 ssl;
#     server_name gw.kiha21.or.kr;
#
#     ssl_certificate     plura/cert.pem;
#     ssl_certificate_key plura/key.pem;
#     include ssl.conf;
#
#     # 관리망만 허용 예시:
#     # allow 10.0.0.0/8;
#     # deny all;
#
#     location / {
#         include plura/ac_0;
#         include plura/defense_0;
#         proxy_pass https://kiha_web_https;
#         include proxy.conf;
#     }
#
#     include server.conf;
# }

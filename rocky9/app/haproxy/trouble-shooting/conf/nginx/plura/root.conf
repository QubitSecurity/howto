# /etc/nginx/plura/root.conf
# -------------------------------------------------------------------
# 목적:
#  - PLURA-WAF 공통 기능(include)과 보안 정책을 "한곳에서" 관리
#  - WAF 2대(이중화)에서 반드시 동일해야 하는 파일
# -------------------------------------------------------------------

# ModSecurity + PLURA rules
include conf.d/plurawaf.conf;

# (선택) GeoIP (사용 시 파일 존재/모듈 로드 필요)
geoip_country /usr/share/GeoIP/GeoIP.dat;

# ------------------------------------------------------------
# Real-IP (HAProxy 뒤에서 실제 클라이언트 IP 복원)
# - set_real_ip_from 은 "WAF가 실제로 보는 HAProxy의 소스 IP"로 설정
# - 다중 NIC/라우팅/SNAT 환경이면 WAF에서 tcpdump로 확인 후 조정
# ------------------------------------------------------------
set_real_ip_from 192.168.101.121;
real_ip_header X-Forwarded-For;
real_ip_recursive on;

# ------------------------------------------------------------
# 접근 통제: WAF는 HAProxy에서만 접근되도록 강제(권장)
# - RealIP 적용 후 $remote_addr 가 바뀌어도,
#   $realip_remote_addr 는 "원래 접속한 프록시 IP"를 유지
# ------------------------------------------------------------
geo $realip_remote_addr $from_haproxy {
    default 0;
    192.168.101.121 1;
}

# acl/pathlist/limit_req/testcookie 등 PLURA 구성요소
include plura/acl;
include plura/pathlist;
include plura/limit_req.conf;
include plura/testcookie.conf;

server_names_hash_bucket_size 256;

# 서비스 서버 정의
include plura/main.conf;

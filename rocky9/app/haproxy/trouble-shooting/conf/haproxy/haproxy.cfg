# /etc/haproxy/haproxy.cfg
# -------------------------------------------------------------------
# 목적:
#  - Client(HTTPS) -> HAProxy(TLS 종료) -> PLURA-WAF(HTTP:80) -> WEB(HTTPS)
#  - WAF는 평문 HTTP로 받아 L7 분석(ModSecurity)을 수행
# -------------------------------------------------------------------

global
    log 127.0.0.1 local0
    daemon
    maxconn 8192
    nbthread 4
    stats socket /var/run/haproxy.sock mode 660 level admin expose-fd listeners

    # TLS 기본값(필요 시 조직 정책에 맞게 조정)
    ssl-default-bind-options ssl-min-ver TLSv1.2
    # ssl-default-bind-ciphers / ssl-default-bind-ciphersuites 는 환경에 맞게 지정

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull

    timeout http-request  10s
    timeout connect       5s
    timeout client        300s
    timeout server        300s

    # 필요 시 재시도 정책
    retries 2

# (선택) 80 -> 443 리다이렉트
frontend fe_http_80
    bind *:80
    mode http
    redirect scheme https code 301 if !{ ssl_fc }

# HTTPS 수신 (TLS 종료)
frontend fe_https_443
    bind *:443 ssl crt-list /etc/haproxy/SSL/crt-list.txt alpn h2,http/1.1
    mode http

    # 원본 클라이언트 IP 전달
    option forwardfor

    # 원래 요청 스킴/포트 전달 (WAF -> WEB로 그대로 전달되도록)
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-Port  443

    default_backend be_waf_http_80

backend be_waf_http_80
    mode http
    balance roundrobin

    # WAF 헬스체크(nginx main.conf에 /health 제공)
    option httpchk GET /health
    http-check expect status 200

    # ★ 중요: WAF는 HTTP(80)로 받도록 구성해야 함
    server waf75 10.10.10.75:80 check
    server waf95 10.10.10.95:80 check

# (선택) HAProxy stats - 외부 노출 금지 권장 / 방화벽 제한 권장
listen stats
    bind *:8888
    mode http
    stats enable
    stats uri /haproxy?stats
    # stats auth <USER>:<STRONG_PASSWORD>

Solr는 Java 기반 애플리케이션(JVM)이기 때문에, Docker 내에서 **메모리, CPU, 힙 설정**을 명확하게 제어하지 않으면, 성능 저하 또는 OOM(Out of Memory) 오류가 발생할 수 있습니다.
아래에 **Docker에서 Solr 리소스 제한 및 JVM 할당을 정확하게 설정하는 방법**을 정리해 드립니다.

---

## ✅ 목표: Solr 컨테이너의 리소스 제한 & JVM 설정 일치

| 리소스 종류     | 제어 방법                                 | JVM 연동 방법         |
| ---------- | ------------------------------------- | ----------------- |
| **CPU**    | `--cpus` or `--cpuset-cpus`           | GC 스레드 수, 병렬도에 영향 |
| **Memory** | `--memory` + `-Xms`, `-Xmx`           | 힙 크기 정확히 지정 필요    |
| **I/O 제한** | `--device-read-bps`, `--blkio-weight` | 디스크 병목 제어 (고급 설정) |

---

## 🛠️ 예시: CPU 4개, 메모리 16GB 제한

```bash
docker run -d \
  --name solr-a1 \
  -p 8983:8983 \
  -v /opt/solr-a1_home:/var/solr \
  --cpus="4.0" \
  --memory="16g" \
  solr:8.11 \
  solr start -c -z zookeeper:2181 \
  -m 12g
```

| 항목               | 설명                                                  |
| ---------------- | --------------------------------------------------- |
| `--cpus="4.0"`   | 컨테이너가 사용할 수 있는 CPU 코어 수 (논리 코어 기준)                  |
| `--memory="16g"` | 컨테이너 메모리 상한선                                        |
| `-m 12g`         | Solr 실행 시 JVM 힙 메모리 크기 설정 (`-Xms12g -Xmx12g` 자동 적용) |
| `-Xms`, `-Xmx`   | 명시적으로 지정도 가능 (`-Xms12g -Xmx12g`)                    |

> ❗ **주의:** `--memory` 제한보다 `-Xmx`가 크면 OOM으로 죽을 수 있음

---

## 💡 CPU 할당 방식 비교

| 옵션                        | 예시            | 설명                   |
| ------------------------- | ------------- | -------------------- |
| `--cpus=4.0`              | 정확한 vCPU 수 제한 | 가장 일반적인 방식           |
| `--cpuset-cpus="0,1,2,3"` | 특정 물리 코어만 사용  | NUMA 영향 줄이고 고성능 가능   |
| `--cpu-shares=512`        | 상대적 CPU 우선순위  | 다른 컨테이너와의 공유 환경에서 사용 |

---

## 💡 메모리 설정 핵심 포인트

| 설정 항목          | 권장 값              | 설명                             |
| -------------- | ----------------- | ------------------------------ |
| `--memory`     | `>= Xmx` + margin | 컨테이너 전체 상한선                    |
| `-Xms`, `-Xmx` | `8g`, `16g` 등     | JVM 힙 최소/최대 값. 동일하게 맞추는 것이 일반적 |
| `-XX:+UseG1GC` | Solr 기본값          | 대용량 JVM에는 적합한 GC               |

---

## 📘 Solr 설정과 Docker 리소스 일치 원칙

> 🔄 **Docker 리소스 제한과 JVM 힙 크기는 반드시 일치해야 합니다.**

예:

* `--memory=16g`
* `-Xms12g -Xmx12g` 또는 `-m 12g`

→ 나머지 4GB는 **OS, Solr 캐시, Lucene 버퍼 등** 비힙 영역에 사용됩니다.

---

## 🧪 성능 관찰 명령어

| 도구                     | 설명                   |
| ---------------------- | -------------------- |
| `docker stats`         | 실시간 CPU/메모리 사용량 모니터링 |
| `jstat -gc <pid>`      | GC 활동 확인             |
| `top`, `htop`, `iotop` | 서버 전체 리소스 관찰         |
| Prometheus + Grafana   | 실시간 대시보드 구성          |

---

## ✅ 운영 팁

* **Solr 1개 컨테이너당** CPU 2~~4코어, 메모리 8~~32GB 적절히 할당
* **복수 컨테이너 운영 시**, 디스크와 포트를 고르게 분산
* **GC 튜닝**: 필요 시 `-XX:+UseParallelGC`, `-XX:+UseG1GC` 등의 옵션 조정
* **OOM 방지**: `--oom-kill-disable` 옵션 + 메모리 제한 확실히 설정

---

## ✅ 결론

> Docker 기반 Solr 운영의 핵심은 “**리소스 제한과 JVM 설정을 정확히 일치시키는 것**”입니다.
> 이를 통해 성능 안정성, 장애 대응력, 예측 가능한 클러스터 운영이 가능해집니다.

---

필요하시면 다음도 도와드릴 수 있습니다:

* 서버당 컨테이너 수에 따른 자원 설계 계산서
* JVM GC 튜닝 추천값
* Prometheus exporter 적용 방법

원하시는 방향 알려 주세요!
